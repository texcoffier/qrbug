<div class="selector_editor">
    <div>
        <h3>Sélecteur actuel :</h3>
        <div id="rendered_selector" style="text-align: center; margin-bottom: 1em; font-size: 1.1em;"></div>
    </div>
    <details class="real_selector"><!-- Add "open" attribute to details tag to open it by default -->
        <summary>Avancé - Sélecteur réel</summary>
        <pre id="raw_selector">%RAW_SELECTOR%</pre>
    </details>
</div>
<div style="display: none;">
    <script>
        (function () {
           const rawSelector = document.getElementById('raw_selector');
            const renderedSelector = document.getElementById('rendered_selector');
            let selectorRepresentation = JSON.parse(rawSelector.textContent);
            const transcribedSelector = transcribeSelector(selectorRepresentation);
            renderedSelector.innerHTML = transcribedSelector[0].toUpperCase() + transcribedSelector.slice(1);
        })();

        function transcribeSelector(selector) {
            let sentence = '';
            if (Array.isArray(selector)) {
                sentence = '(' + transcribeSelector(selector[1]) + [" <b>OU</b> ", " <b>ET</b> "][selector[0]] + transcribeSelector(selector[2]) + ')';
            } else {
                for (const [key, value] of Object.entries(selector)) {
                    if (key === 'test') {
                        switch (value) {
                            case 'active':
                                sentence += 'L\'Incident est actif';
                                break;
                            case 'contains':
                                sentence += ` contient <i>${selector.value}</i>`;
                                break;
                            case 'true':
                                sentence += ' est vrai';
                                break;
                            case 'false':
                                sentence += ' est faux';
                                break;
                            case 'pending_feedback':
                                sentence += ' en attente de retours';
                                break;
                            case 'is_for_thing':
                                sentence += ' est pour l\'objet';
                                break;
                            case 'is_for_user':
                                sentence += ' est pour l\'utilisateur';
                                break;
                            case 'in':
                                if (selector?.class === 'User' || selector?.class === 'Failure') {
                                    sentence += ` est dans le groupe <i>${selector.value}</i>`;
                                } else {
                                    sentence += ` est dans <i>${selector.value}</i>`;
                                }
                                break;
                            case 'in_or_equal':
                                sentence += ` est dans/est <i>${selector.value}</i>`;
                                break;
                            case 'is':
                                sentence += ` est <i>${selector.value}</i>`;
                                break;
                            default:
                                if (['<','>','<=','>=','='].includes(value)) {
                                    sentence += ` ${value} <i>${selector.value}</i>`;
                                } else {
                                    throw new Error("Test selector not known");
                                }
                                break;
                        }
                    }
                    else if (key === 'class') {
                        switch (value) {
                            case 'Incident':
                                sentence += `l\'Incident`;
                                break;
                            case 'Thing':
                                sentence += `l\'Objet`;
                                break;
                            case 'Failure':
                                sentence += `la Panne`;
                                break;
                            case 'User':
                                sentence += `l\'Utilisateur`;
                                break;
                            case 'Selector':
                                sentence += `le Sélecteur d'ID "${selector.id}"`;
                                break;
                            case 'SourceThing':
                                sentence += `l\'Objet Source`;
                                break;
                            case 'SourceFailure':
                                sentence += `la Panne Source`;
                                break;
                            case 'SourceUser':
                                sentence += `l\'Utilisateur Source`;
                                break;
                            default:
                                throw new Error("Class selector not known");
                        }
                    }
                    else if (key === 'attr') {
                        sentence += ` <i>(attribut "${value}")</i>`;
                    }
                }
            }
            return sentence;
        }
    </script>
    <!-- The script above is not executed until the "image" below injects it into the HTML code above. -->
    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onload="const scriptCode = this.parentElement.querySelector('script').innerHTML; const scriptNode = document.createElement('script'); scriptNode.innerHTML = scriptCode; this.parentElement.appendChild(scriptNode);">
</div>
