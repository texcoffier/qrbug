<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
    <style>
        body {
            font-family: sans-serif;
            font-size: 1.2em;
            box-sizing: border-box ;
            margin: var(--body-margin);
            --body-margin: 0.5em;
            --margin: 0px;
            --button-margin: 0.2em;
            --button-width: calc(100vw - 2 * var(--button-margin));
            --button-height: 2.5em;
        }
        * {
            box-sizing: border-box ;
        }

        div.button {
            display: inline-block;
            border: 0.1em outset #888;
            border-radius: 0.5em;
            margin: var(--button-margin);
            padding: 0.2em;
            background: #EEE;
        }

        div.button:hover {
            border: 0.1em inset #888;
            background: #DDD;
        }

        input {
            font-size: 1.2em;
        }

        IFRAME {
            display: block;
            border: 0px;
            background: #EEE;
            width: 100%;
            height: 5em;
        }

        @media (orientation: portrait) {
            BODY, BUTTON {
                font-size: 5vw;
                --body-margin: 0px;
            }
            H1 {
                font-size: 6vw;
            }

            DIV.button {
                display: inline-flex;
                width: var(--button-width);
                min-height: var(--button-height);
                text-align: center;
                vertical-align: top;
                border: 0px;
                border-radius: 1em;
            }
            DIV.button:hover {
                border: 0px;
            }
            DIV.input DIV {
                display: flex;
            }
            DIV.input DIV INPUT {
                flex: 1;
                margin-right: 0.5em;
            }

            BOX {
                display: flex;
                align-items: center;
                cursor: pointer;
            }

            P {
                margin: 0px;
                text-align: center;
                font-weight: bold;
            }

            INPUT {
                border: 0px;
                background: #F8F8F8;
            }
        }
    </style>

    <script>
        function register_incident(element, in_place) {
            while ( ! element.getAttribute('thingid') )
                element = element.parentNode;
            let url = '/?thing-id=' + element.getAttribute('thingid')
                + '&failure-id=' + element.getAttribute('failureid')
                + '&what=' + element.getAttribute('what')
                + '&is-repaired=0'
                + (location.search ? location.search.replace('?', '&') : '') // ticket
                ;
            let input = document.getElementById('input')
                || (element.tagName == 'INPUT' ? element : undefined)
                || (element.previousElementSibling
                    && element.previousElementSibling.tagName == 'INPUT'
                    ? element.previousElementSibling : undefined)
                ;
            let value = input ? input.value : undefined;
            if (value)
                url += '&additional-info=' + encodeURIComponent(value);
            if(in_place) {
                iframe = document.createElement('IFRAME');
                iframe.src = url;
                element.parentNode.appendChild(iframe);
            } else {
                window.location = url;
            }
        }
        function close_dialog(event) {
            document.getElementById('popup').remove();
            event.stopPropagation();
        }
        function ask_value(element, in_place) {
            if (document.getElementById('popup')) {
                return;
            }
            popup = document.createElement('DIALOG');
            popup.id = 'popup';
            popup.method = "dialog";
            popup.onclose = close_dialog;
            txt = '<b>' + element.innerHTML + '</b><br>'
                + '<p>Précisez le problème :</p>'
                + '<textarea id="input" autocomplete="off"'
                + '       style="width:100%; font-size:120%; height:5em; margin-bottom: 1em;"'
                + '       onkeypress="if(event.key==\'Enter\')register_incident(this,' + in_place + ')">'
                + '</textarea>'
                + '<button onclick="close_dialog(event)" style="font-size:120%;float:left">Annuler</button>'
                + '<button onclick="register_incident(this,' + in_place + ');close_dialog(event)" style="font-size:120%;float:right">Envoyer</button>';
            popup.innerHTML = txt;
            element.appendChild(popup);
            document.getElementById('input').textContent = element.value;
            popup.showModal();
        }
    </script>
</head>

<body>
    %REPRESENTATION%
</body>